generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id                    String                    @id @default(cuid())
  email                 String                    @unique
  phone                 String?                   @unique
  passwordHash          String?
  googleId              String?                   @unique
  appleId               String?                   @unique
  firstName             String
  lastName              String
  displayName           String?
  avatarUrl             String?
  dateOfBirth           DateTime?
  gender                Gender?
  fitnessGoal           FitnessGoal?
  activityLevel         ActivityLevel?
  heightCm              Float?
  currentWeightKg       Float?
  targetWeightKg        Float?
  fitnessLevel          DifficultyLevel           @default(BEGINNER)
  role                  UserRole                  @default(USER)
  language              String                    @default("en")
  measurementUnit       String                    @default("metric")
  notificationsEnabled  Boolean                   @default(true)
  // Content moderation
  bannedAt              DateTime?
  uploadBanReason       String?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  lastActiveAt          DateTime                  @default(now())
  onboardingCompletedAt DateTime?
  contentViolations     ContentViolation[]
  conversations         ConversationParticipant[]
  mealLogs              MealLog[]
  mealPlans             MealPlan[]
  sentMessages          Message[]                 @relation("SentMessages")
  progressLogs          ProgressLog[]
  progressPhotos        ProgressPhoto[]
  streaks               Streak[]
  subscription          Subscription?
  trainers              TrainerClient[]           @relation("ClientTrainers")
  trainerProfile        TrainerProfile?
  aiPreferences         UserAIPreference?
  achievements          UserAchievement[]
  equipment             UserEquipment[]
  workoutLogs           WorkoutLog[]
  workoutPlans          WorkoutPlan[]
  receivedMessages      Message[]                 @relation("ReceivedMessages")

  @@index([email])
  @@index([phone])
  @@index([role])
}

model UserEquipment {
  id        String        @id @default(cuid())
  userId    String
  equipment EquipmentType
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, equipment])
}

model UserAIPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  isVegetarian      Boolean  @default(false)
  isVegan           Boolean  @default(false)
  isKeto            Boolean  @default(false)
  isPescatarian     Boolean  @default(false)
  allergies         String[] @default([])
  dislikes          String[] @default([])
  healthConditions  String[] @default([])
  medications       String[] @default([])
  preferLocalFoods  Boolean  @default(true)
  budgetLevel       String   @default("moderate")
  cookingSkillLevel String   @default("intermediate")
  maxCookingTime    Int      @default(30)
  // Ramadan Mode Settings
  ramadanModeEnabled    Boolean  @default(false)
  ramadanIftarTime      String?  // e.g., "18:30"
  ramadanSuhoorTime     String?  // e.g., "04:00"
  ramadanWorkoutTiming  String   @default("after_iftar") // before_iftar, after_iftar, after_taraweeh, before_suhoor
  ramadanFastingDays    String[] @default([]) // track which days user is fasting
  // Injury Settings
  injuries              String[] @default([]) // e.g., ["knee", "lower_back", "shoulder"]
  // Workout Preferences
  preferredWorkoutTime  String?  // e.g., "morning", "afternoon", "evening"
  availableEquipment    String[] @default([])
  workoutDurationMins   Int      @default(45)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Exercise {
  id               String                 @id @default(cuid())
  externalId       String                 @unique
  nameEn           String
  nameAr           String
  descriptionEn    String?
  descriptionAr    String?
  category         ExerciseCategory
  primaryMuscle    MuscleGroup
  secondaryMuscles MuscleGroup[]
  equipment        EquipmentType[]
  difficulty       DifficultyLevel
  thumbnailUrl     String?
  videoUrl         String?
  instructionsEn   String[]
  instructionsAr   String[]
  tipsEn           String[]
  tipsAr           String[]
  isTimeBased      Boolean                @default(false)
  defaultSets      Int                    @default(3)
  defaultReps      Int?                   @default(10)
  defaultDuration  Int?
  defaultRest      Int                    @default(60)
  tags             String[]
  embedding        Unsupported("vector")?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  exerciseLogs     ExerciseLog[]
  workoutExercises WorkoutExercise[]

  @@index([primaryMuscle])
  @@index([category])
  @@index([difficulty])
}

model WorkoutPlan {
  id            String          @id @default(cuid())
  userId        String
  trainerId     String?
  nameEn        String
  nameAr        String
  descriptionEn String?
  descriptionAr String?
  durationWeeks Int             @default(4)
  daysPerWeek   Int             @default(4)
  difficulty    DifficultyLevel
  goal          FitnessGoal
  isActive      Boolean         @default(true)
  isAIGenerated Boolean         @default(false)
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  workouts      Workout[]
  trainer       TrainerProfile? @relation(fields: [trainerId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model Workout {
  id               String            @id @default(cuid())
  planId           String
  weekNumber       Int
  dayOfWeek        Int
  nameEn           String
  nameAr           String
  focusMuscles     MuscleGroup[]
  estimatedMinutes Int               @default(45)
  plan             WorkoutPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  exercises        WorkoutExercise[]
  logs             WorkoutLog[]

  @@index([planId])
  @@index([weekNumber, dayOfWeek])
}

model WorkoutExercise {
  id          String   @id @default(cuid())
  workoutId   String
  exerciseId  String
  order       Int
  sets        Int
  reps        Int?
  duration    Int?
  restSeconds Int      @default(60)
  notesEn     String?
  notesAr     String?
  exercise    Exercise @relation(fields: [exerciseId], references: [id])
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([workoutId])
  @@index([exerciseId])
}

model WorkoutLog {
  id              String        @id @default(cuid())
  userId          String
  workoutId       String?
  manualName      String?
  scheduledDate   DateTime
  startedAt       DateTime?
  completedAt     DateTime?
  status          WorkoutStatus @default(SCHEDULED)
  totalVolume     Float?
  durationMinutes Int?
  caloriesBurned  Int?
  rating          Int?
  notes           String?
  exerciseLogs    ExerciseLog[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout         Workout?      @relation(fields: [workoutId], references: [id])

  @@index([userId])
  @@index([scheduledDate])
  @@index([status])
}

model ExerciseLog {
  id           String     @id @default(cuid())
  workoutLogId String
  exerciseId   String
  completedAt  DateTime   @default(now())
  exercise     Exercise   @relation(fields: [exerciseId], references: [id])
  workoutLog   WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  sets         SetLog[]

  @@index([workoutLogId])
  @@index([exerciseId])
}

model SetLog {
  id            String      @id @default(cuid())
  exerciseLogId String
  setNumber     Int
  reps          Int?
  weightKg      Float?
  duration      Int?
  rpe           Int?
  completedAt   DateTime    @default(now())
  exerciseLog   ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)

  @@index([exerciseLogId])
}

model Food {
  id               String                 @id @default(cuid())
  externalId       String?                @unique
  nameEn           String
  nameAr           String
  brandEn          String?
  brandAr          String?
  isEgyptian       Boolean                @default(false)
  availableAt      String[]
  category         String
  subcategory      String?
  servingSizeG     Float
  servingUnit      String                 @default("g")
  calories         Float
  proteinG         Float
  carbsG           Float
  fatG             Float
  fiberG           Float?
  sugarG           Float?
  sodiumMg         Float?
  vitaminAIU       Float?
  vitaminCMg       Float?
  calciumMg        Float?
  ironMg           Float?
  potassiumMg      Float?
  imageUrl         String?
  barcode          String?
  tags             String[]
  embedding        Unsupported("vector")?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  mealFoods        MealFood[]
  plannedMealFoods PlannedMealFood[]

  @@index([category])
  @@index([isEgyptian])
  @@index([barcode])
}

model MealPlan {
  id             String        @id @default(cuid())
  userId         String
  trainerId      String?
  nameEn         String
  nameAr         String
  targetCalories Int
  targetProteinG Int
  targetCarbsG   Int
  targetFatG     Int
  durationDays   Int           @default(7)
  isActive       Boolean       @default(true)
  isAIGenerated  Boolean       @default(false)
  startDate      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  meals          PlannedMeal[]

  @@index([userId])
  @@index([isActive])
}

model PlannedMeal {
  id        String            @id @default(cuid())
  planId    String
  dayNumber Int
  mealType  MealType
  nameEn    String?
  nameAr    String?
  plan      MealPlan          @relation(fields: [planId], references: [id], onDelete: Cascade)
  foods     PlannedMealFood[]

  @@index([planId])
}

model PlannedMealFood {
  id            String      @id @default(cuid())
  plannedMealId String
  foodId        String
  servings      Float       @default(1)
  food          Food        @relation(fields: [foodId], references: [id])
  plannedMeal   PlannedMeal @relation(fields: [plannedMealId], references: [id], onDelete: Cascade)

  @@index([plannedMealId])
}

model MealLog {
  id            String     @id @default(cuid())
  userId        String
  loggedAt      DateTime   @default(now())
  mealType      MealType
  notes         String?
  photoUrl      String?
  totalCalories Float?
  totalProteinG Float?
  totalCarbsG   Float?
  totalFatG     Float?
  foods         MealFood[]
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loggedAt])
}

model MealFood {
  id        String  @id @default(cuid())
  mealLogId String
  foodId    String
  servings  Float   @default(1)
  food      Food    @relation(fields: [foodId], references: [id])
  mealLog   MealLog @relation(fields: [mealLogId], references: [id], onDelete: Cascade)

  @@index([mealLogId])
}

model ProgressLog {
  id                     String   @id @default(cuid())
  userId                 String
  loggedAt               DateTime @default(now())
  weightKg               Float?
  bodyFatPercent         Float?
  chestCm                Float?
  waistCm                Float?
  hipsCm                 Float?
  thighCm                Float?
  bicepCm                Float?
  restingHR              Int?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  sleepHours             Float?
  stepsCount             Int?
  notes                  String?
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loggedAt])
}

model ProgressPhoto {
  id                String   @id @default(cuid())
  userId            String
  photoUrl          String
  thumbnailUrl      String?
  angle             String?
  loggedAt          DateTime @default(now())
  notes             String?
  isPublic          Boolean  @default(false)
  sharedWithTrainer Boolean  @default(false)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loggedAt])
}

model TrainerProfile {
  id                 String                 @id @default(cuid())
  userId             String                 @unique
  bio                String?
  specializations    String[]
  yearsExperience    Int                    @default(0)
  instagramHandle    String?
  instagramFollowers Int?
  monthlyPrice       Int
  averageRating      Float                  @default(0)
  totalReviews       Int                    @default(0)
  status             TrainerStatus          @default(PENDING)
  verifiedAt         DateTime?
  maxClients         Int                    @default(20)
  acceptingClients   Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  certifications     TrainerCertification[]
  clients            TrainerClient[]
  user               User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews            TrainerReview[]
  workoutPlans       WorkoutPlan[]

  @@index([status])
  @@index([averageRating])
}

model TrainerCertification {
  id          String         @id @default(cuid())
  trainerId   String
  name        String
  issuingBody String
  issueDate   DateTime?
  expiryDate  DateTime?
  documentUrl String?
  isVerified  Boolean        @default(false)
  verifiedAt  DateTime?
  trainer     TrainerProfile @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId])
}

model TrainerClient {
  id        String         @id @default(cuid())
  trainerId String
  clientId  String
  isActive  Boolean        @default(true)
  startDate DateTime       @default(now())
  endDate   DateTime?
  notes     String?
  client    User           @relation("ClientTrainers", fields: [clientId], references: [id], onDelete: Cascade)
  trainer   TrainerProfile @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@unique([trainerId, clientId])
  @@index([trainerId])
  @@index([clientId])
}

model TrainerReview {
  id        String         @id @default(cuid())
  trainerId String
  clientId  String
  rating    Int
  comment   String?
  createdAt DateTime       @default(now())
  trainer   TrainerProfile @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  priceEGP             Int                @default(0)
  billingCycle         String             @default("monthly")
  startDate            DateTime           @default(now())
  endDate              DateTime?
  trialEndDate         DateTime?
  cancelledAt          DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  payments             Payment[]
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@index([status])
}

model Payment {
  id              String       @id @default(cuid())
  subscriptionId  String
  amountEGP       Int
  currency        String       @default("EGP")
  status          String
  stripePaymentId String?
  createdAt       DateTime     @default(now())
  paidAt          DateTime?
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
}

model Conversation {
  id            String                    @id @default(cuid())
  isGroup       Boolean                   @default(false)
  name          String?
  lastMessageAt DateTime?
  createdAt     DateTime                  @default(now())
  participants  ConversationParticipant[]
  messages      Message[]
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  type           MessageType  @default(TEXT)
  content        String
  mediaUrl       String?
  isEdited       Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  editedAt       DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  recipients     User[]       @relation("ReceivedMessages")

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Achievement {
  id            String            @id @default(cuid())
  code          String            @unique
  nameEn        String
  nameAr        String
  descriptionEn String
  descriptionAr String
  iconUrl       String?
  badgeColor    String?
  category      String
  requirement   Json
  xpReward      Int               @default(0)
  users         UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Float       @default(0)
  unlockedAt    DateTime?
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

model Streak {
  id             String    @id @default(cuid())
  userId         String
  type           String
  currentCount   Int       @default(0)
  longestCount   Int       @default(0)
  lastActivityAt DateTime?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model Video {
  id              String        @id @default(cuid())
  youtubeId       String        @unique
  title           String
  titleAr         String?
  description     String?
  descriptionAr   String?
  category        VideoCategory
  tags            String[]
  durationSeconds Int?
  thumbnailUrl    String?
  vectorData      Json?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([category])
  @@index([isActive])
}

// Squad/Group Accountability System
model Squad {
  id          String        @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  isPublic    Boolean       @default(true)
  maxMembers  Int           @default(20)
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     SquadMember[]
  activities  SquadActivity[]
  challenges  SquadChallenge[]

  @@index([isPublic])
}

model SquadMember {
  id        String   @id @default(cuid())
  squadId   String
  userId    String
  role      String   @default("member") // admin, moderator, member
  joinedAt  DateTime @default(now())
  squad     Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@unique([squadId, userId])
  @@index([userId])
}

model SquadActivity {
  id          String   @id @default(cuid())
  squadId     String
  userId      String
  type        String   // workout_completed, streak_milestone, challenge_joined, etc.
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  squad       Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@index([squadId])
  @@index([createdAt])
}

model SquadChallenge {
  id          String    @id @default(cuid())
  squadId     String
  name        String
  description String?
  type        String    // workout_count, total_volume, streak_days, etc.
  target      Int
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime  @default(now())
  squad       Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@index([squadId])
  @@index([endDate])
}

// Content Moderation
model ContentViolation {
  id          String   @id @default(cuid())
  userId      String
  resourceId  String   // Cloudinary public_id or message ID
  type        String   // IMAGE, VIDEO, TEXT
  reason      String
  detectedAt  DateTime
  reviewedAt  DateTime?
  reviewedBy  String?
  action      String?  // warned, banned, cleared
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([reviewedAt])
}

enum UserRole {
  USER
  TRAINER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
}

enum FitnessGoal {
  LOSE_WEIGHT
  BUILD_MUSCLE
  MAINTAIN
  IMPROVE_HEALTH
  INCREASE_STRENGTH
  IMPROVE_ENDURANCE
}

enum ActivityLevel {
  SEDENTARY
  LIGHTLY_ACTIVE
  MODERATELY_ACTIVE
  VERY_ACTIVE
  EXTREMELY_ACTIVE
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum MuscleGroup {
  CHEST
  BACK
  SHOULDERS
  BICEPS
  TRICEPS
  FOREARMS
  ABS
  OBLIQUES
  LOWER_BACK
  GLUTES
  QUADRICEPS
  HAMSTRINGS
  CALVES
  FULL_BODY
  CARDIO
}

enum EquipmentType {
  NONE
  BODYWEIGHT
  DUMBBELLS
  BARBELL
  KETTLEBELL
  CABLES
  MACHINES
  RESISTANCE_BANDS
  TRX
  PULL_UP_BAR
  BENCH
  STABILITY_BALL
  FOAM_ROLLER
  JUMP_ROPE
  TREADMILL
  BIKE
  ROWING
}

enum ExerciseCategory {
  STRENGTH
  CARDIO
  FLEXIBILITY
  BALANCE
  PLYOMETRIC
  OLYMPIC
  CALISTHENICS
  YOGA
  PILATES
  MOBILITY
}

enum VideoCategory {
  YOGA
  CALISTHENICS
  HIIT
  STRETCHING
  MEDITATION
  STRENGTH
  CARDIO
  TUTORIAL
}

enum WorkoutStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  PRE_WORKOUT
  POST_WORKOUT
}

enum SubscriptionTier {
  FREE
  PREMIUM
  PREMIUM_PLUS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum TrainerStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  SUSPENDED
}

enum MessageType {
  TEXT
  IMAGE
  VOICE
  WORKOUT_SHARE
  PROGRESS_SHARE
}
